<script setup>
    import {ref, computed, watch, inject, provide, nextTick, onMounted, onUnmounted} from 'vue'
    import Dialogue from './Dialogue.vue'
    import Settings from './Setting.vue'
    import Option from './type/Option.vue'
    import CharSelector from './CharSelector.vue'
    import Savefile from './components/Savefile.vue'

    import message from '@/lib/message'
    import {
        copy,
        uuid,
        downloadImage,
        blob2url,
        blob2base64,
        image2square,
        ensureClose,
        clickBySelector,
        getDialogue,
        doAfterMounted
    } from "@/lib/tool";
    import {
        StaticUrl,
        TypeDict,
        TypeHint,
        TypeDefault
    } from "@/lib/constance";
    import {
        config,
        chats,
        chars,
        images,
        avatars,
        DataControl
    } from '@/lib/data'
    import {
        uploadData,
        downloadData
    } from '@/lib/versionControl'
    import {
        CharDict,
        loadChar,
        sortChar,
        searchResult,
        searchCharHandler,
        AvatarSuffix
    } from '@/lib/character'

    const controller = new AbortController();
    document.addEventListener('keydown', event => {
        if (event.ctrlKey) {
            if (['TEXTAREA', 'INPUT'].indexOf(event.target.nodeName) === -1 || event.altKey) {
                if (event.code === 'KeyC') {
                    createChar.value = true;
                    ifShowEditChar.value = true;
                    event.preventDefault()
                }
            } else if (event.code.indexOf('Digit') === 0 || event.code.indexOf('Numpad') === 0) {
                const index = (+event.key || 10) - 1;
                const list = Object.entries(chars.value);
                if (index < list.length) {
                    setCurr(list[index][0])
                } else {
                    createChar.value = true;
                    ifShowEditChar.value = true;
                }
                event.preventDefault()
            }
        }
    }, {signal: controller.signal});
    onUnmounted(() => {
        controller.abort()
    });

    const editor = computed(() => {
        if (['char', 'monologue', 'image'].indexOf(currDialogueData.value.type) !== -1) {
            return false
        } else if (currDialogueData.value.type === 'option') {
            return Option
        }
    });

    const ifShowAnnouncement = inject('ifShowAnnouncement');
    const ifShowAbout = inject('ifShowAbout');
    const ifShowSettings = inject('ifShowSettings');
    const ifShowSavefile = ref(false);
    const renderSettings = ref({});
    const width = ref({});
    const windowWidth = Math.min(520, document.body.clientWidth);
    const dialogWidth = Math.ceil(windowWidth * 0.9);
    const avatarBarFrameWidth = Math.floor((dialogWidth - 48) / 4) + 'px';
    provide('renderSettings', renderSettings);
    provide('width', width);
    provide('dialogWidth', dialogWidth);

    function toGuide() {
        location.href = '/docs/guide/start.html'
    }

    const charDirection = computed(() => {
        const dict = chars.value;
        let left = false;
        let right = false;
        for (let char in dict) {
            if (dict.hasOwnProperty(char)) {
                if (dict[char].right) {
                    right = true
                } else {
                    left = true
                }
            }
        }
        return [left, right]
    });
    provide('charDirection', charDirection);

    const ResizeWindow = {
        time: 0,
        get(size) {
            return (this.time === 1 ? size : Math.ceil(this.time * size)) + 'px'
        },
        size: {
            avatar: 60,
            fontsize: 16
        },
        resize() {
            const max = renderSettings.value.width + (charDirection.value[0] && charDirection.value[1] ? 120 : 60);
            if (preScreenshot.value) {
                width.value.window = max;
                width.value.image = renderSettings.value.width - (charDirection.value[0] && charDirection.value[1] ? 20 : 10) - 16 + 'px';
                this.time = 1;
            } else {
                const w = Math.min(max, document.body.clientWidth);
                width.value.window = w;
                if (w === max) {
                    this.time = 1
                } else {
                    this.time = w / max
                }
            }
            for (let key in this.size) {
                if (this.size.hasOwnProperty(key)) {
                    width.value[key] = this.get(this.size[key])
                }
            }
        }
    };

    onMounted(() => {
        ResizeWindow.resize()
    });
    watch(charDirection, () => {
        ResizeWindow.resize()
    });
    watch(() => {
        return renderSettings.value.width
    }, () => {
        ResizeWindow.resize()
    });

    function resizeBody(offset = 0) {
        const el = document.getElementById('body');
        el.style.height = window.innerHeight - offset + 'px';
        el.style.cssText += 'transition: background-color ease 1s;';
        nextTick(() => {
            if (el.scrollWidth < window.innerWidth && offset < 5) {
                resizeBody(offset + 1)
            }
        })
    }

    onMounted(() => {
        resizeBody()
    });

    const textarea = ref('');
    const scroll = ref();
    const preScreenshot = ref(false);
    const ifShowMoreType = ref(false);
    const arrowStyle = ref({});
    const options = ref({});
    const ifShowCreateOption = ref(false);
    provide('preScreenshot', preScreenshot);

    function roll360() {
        if (ifShowMoreType.value) {
            arrowStyle.value = {
                transform: 'rotate(180deg)',
                transition: 'transform ease 0.4s'
            };
            resizeScroll(-100)
        } else {
            arrowStyle.value = {
                transform: 'rotate(360deg)',
                transition: 'transform ease 0.4s'
            };
            setTimeout(() => {
                arrowStyle.value = {}
            }, 500);
            resizeScroll(100)
        }
    }

    const currChar = ref('');
    const ifShowEditChar = ref(false);
    const ifShowSelectChar = ref(false);
    const defaultName = ref('');
    const createChar = ref(true);
    const newChar = ref({name: ''});
    const searchChar = ref('');

    function initSearchChar() {
        const el = document.querySelector('#searchCharInput');
        el.addEventListener('input', (event) => {
            searchCharHandler(el.value)
        });
        searchCharHandler('')
    }

    const ifShowEditDialogue = ref(false);
    const currDialogue = ref(-1);
    const currDialogueData = ref({});
    const editDialogue = ref(true);

    const showToolBar = ref(false);
    const toolBarMask = ref(true);

    // @列表处理
    const ifShowAt = ref(false);
    const atWho = ref('');
    const atWhoSelRef = ref(null);
    let insertAt = 0;

    function handleAt(id) {
        // 被@角色刷入文本框
        textarea.value = textarea.value.slice(0, insertAt)
            + chars.value[id].name
            + " "
            + textarea.value.slice(insertAt);
        atWho.value = '';
        if (atWhoSelRef.value) {
            atWhoSelRef.value.blur()
        }
        ifShowAt.value = false;
        setTimeout(() => {
            const el = document.querySelector('#textarea');
            const range = insertAt + chars.value[id].name.length + 1;
            el.focus();
            el.setSelectionRange(range, range);
        }, 100)
    }

    function atWhoOpen() {
        // @提示框显示后聚焦输入
        doAfterMounted(atWhoSelRef, (ref) => {
            // 等待动画结束
            setTimeout(() => {
                ref.value.focus()
            }, 150);
        })
    }

    function processInput(e) {
        // 处理键入@事件
        if (e.data === '@' && (e.inputType === "insertText" || e.inputType === 'insertCompositionText')) {
            if (ifShowAt.value) {
                textarea.value = e.target.value.slice(0, e.target.selectionStart - 1) + e.target.value.slice(e.target.selectionStart);
                insertAt = e.target.selectionStart - 1;
            } else {
                insertAt = e.target.selectionStart;
                ifShowAt.value = true;
                atWhoOpen();
            }
        }
    }

    // +1功能
    const plus1 = ref(-1);

    function plus1Hook(index) {
        if (index > 0) {
            const c1 = chats.value[index];
            const c2 = chats.value[index - 1];
            if (c1.content === c2.content && c1.type === c2.type) {
                plus1.value = index;
            } else {
                plus1.value = -1
            }
        } else {
            plus1.value = -1
        }
    }

    if (window.innerWidth - 520 > 250) {
        showToolBar.value = true;
        toolBarMask.value = false
    } else {
        showToolBar.value = false;
        toolBarMask.value = true
    }

    function resizeScroll(offset = 0) {
        const el = document.getElementById('textarea');
        el.style.height = '20px';
        const height = el.scrollHeight > 20 ? el.scrollHeight : 20;
        el.style.height = height + 'px';
        const bar = document.getElementById('operateBar');
        scrollHeight.value = bar.offsetTop + offset + 'px'
    }

    watch(textarea, () => {
        resizeScroll()
    });
    window.onresize = () => {
        resizeScroll();
        resizeBody()
    };

    const scrollHeight = ref(window.innerHeight - 90 + 'px');

    const tipControl = {
        tip: ref(''),
        pool: [
            '素材库里除了有干员头像，还有召唤物/敌人/装置的',
            '上传的头像会自动剪裁成正方形',
            '博士，剿灭打了吗？',
            '点击对话框可以编辑/插入对话',
            '不选中任何角色时，将以旁白视角发送对话',
            'Ctrl+Enter可以快捷发送',
            'Ctrl+Z/ctrl+Y可以撤回/重做',
            'Ctrl+1~9可以快捷切换角色'
        ],
        cache: [],
        until: 0,
        cd: 5000,
        loop() {
            if (Date.now() > this.until) {
                if (this.cache.length < 1) {
                    this.cache = copy(this.pool)
                }
                const p = Math.floor(Math.random() * this.cache.length) - 1;
                this.tip.value = this.cache.splice(p, 1);
                nextTick(() => {
                    resizeScroll()
                })
            }
            setTimeout(() => {
                this.loop()
            }, this.cd)
        },
        setTmpTip(tip, timeout = 5000) {
            this.tip.value = tip;
            this.until = Date.now() + timeout
        }
    };
    onMounted(() => {
        tipControl.loop();
    });


    function createDialogue(data, locate = true) {
        data = {
            content: data.content,
            type: data.type,
            char: data.hasOwnProperty('char') ? data.char : currChar.value,
            id: data.id || uuid()
        };
        chats.value.push(data);
        DataControl.save('chats');
        plus1Hook(chats.value.length - 1);
        nextTick(() => {
            resizeScroll();
            if (locate) {
                const el = getDialogue(data.id);
                scroll.value.setScrollTop(el.offsetTop)
            }
        });
    }

    function copyDialogue(index, data = {}, config = {}) {
        data = {
            content: data.content || chats.value[index].content,
            type: data.type || chats.value[index].type,
            char: data.hasOwnProperty('char') ? data.char : currChar.value,
            id: data.id || uuid()
        };
        if (data.type === 'image') {
            DataControl.image.count(data.content)
        }
        chats.value.push(data);
        if (config.hasOwnProperty('save') ? config.save : true) {
            DataControl.save('chats');
            plus1Hook(chats.value.length - 1);
        }
        nextTick(() => {
            resizeScroll();
            if (config.hasOwnProperty('locate') ? config.locate : true) {
                const el = getDialogue(data.id);
                scroll.value.setScrollTop(el.offsetTop)
            }
        });
    }

    function createTextDialogue(type) {
        if (textarea.value) {
            createDialogue({
                content: textarea.value,
                type: type,
            });
            textarea.value = '';
        } else {
            message.notify('请在输入框内输入文本', message.info);
            tipControl.setTmpTip('请在此输入文本')
        }
    }

    function createImageDialogue(fileUpload) {
        DataControl.image.new(fileUpload, (id) => {
            createDialogue({
                content: id,
                type: 'image',
            });
        });
        return false
    }

    function uploadImage(fileUpload) {
        DataControl.image.new(fileUpload, (id) => {
            if (currDialogueData.value.type === 'image') {
                DataControl.image.delete(currDialogueData.value.content)
            }
            currDialogueData.value.content = id
        });
        return false
    }

    function clearDialogueData() {
        if (!editDialogue.value && currDialogueData.value.type === 'image') {
            DataControl.image.delete(currDialogueData.value.content)
        }
        currDialogueData.value = {}
    }

    function setCurr(id) {
        if (id === currChar.value) {
            currChar.value = ''
        } else {
            currChar.value = id
        }
    }

    function showEditChar(create) {
        createChar.value = create;
        if (create) {
            newChar.value = {name: ''};
        } else {
            if (currChar.value) {
                newChar.value = chars.value[currChar.value];
            } else {
                message.notify('请选择角色', message.warning);
                return
            }
        }
        searchResult.value = false;
        ifShowEditChar.value = true
    }

    function uploadAvatar(uploadFile) {
        const url = blob2url(uploadFile);
        if (url) {
            const image = new Image();
            image.onload = () => {
                image2square(image).toBlob((blob) => {
                    DataControl.image.new(blob, (id) => {
                        DataControl.image.delete(newChar.value.avatar);
                        newChar.value.avatar = id
                    });
                })
            };
            image.src = url;
        }
        return false
    }

    DataControl.switchHook = () => {
        if (!chars.value.hasOwnProperty(currChar.value)) {
            currChar.value = ''
        }
    };

    function selectChar(avatar) {
        DataControl.image.delete(newChar.value.avatar);
        newChar.value.avatar = avatar[1];
        ifShowSelectChar.value = false
    }

    function editChar() {
        if (createChar.value) {
            if (newChar.value.name === '' && !defaultName.value) {
                message.notify('名字是必须的', message.error);
                return
            }
            if (newChar.value.name === '') {
                newChar.value.name = defaultName.value
            }
            currChar.value = DataControl.char.new(newChar.value);
            ifShowEditChar.value = false;
            newChar.value = {name: ''};
            message.notify('创建成功', message.success);
            if (!toolBarMask.value) {
                document.getElementById('textarea').focus();
            }
        } else {
            message.confirm(
                '即将删除该角色',
                '提示',
                () => {
                    DataControl.char.delete(currChar.value);
                    currChar.value = '';
                    message.notify('删除成功', message.success);
                    ifShowEditChar.value = false;
                }
            )
        }
    }

    function clearNewChar() {
        if (createChar.value && newChar.value) {
            DataControl.image.delete(newChar.value.avatar)
        }
        newChar.value = {name: ''};
        defaultName.value = ''
    }

    function showEditDialogue(index) {
        editDialogue.value = true;
        currDialogue.value = index;
        currDialogueData.value = chats.value[currDialogue.value];
        ifShowEditDialogue.value = true
    }

    function switchEdit(edit) {
        editDialogue.value = edit;
        if (edit) {
            currDialogueData.value = chats.value[currDialogue.value];
        } else {
            currDialogueData.value = {}
        }
    }

    function delDialogue() {
        message.confirm(
            '即将删除该对话',
            '提示',
            () => {
                let chat = chats.value.splice(currDialogue.value, 1)[0];
                if (chat.type === 'image') {
                    DataControl.image.delete(chat.content);
                }
                message.notify('删除成功', message.success);
                ifShowEditDialogue.value = false;
            }
        );
    }

    function insertDialogue() {
        if (currDialogueData.value.char === undefined) {
            message.notify('请选择角色', message.warning);
            return
        }
        if (!currDialogueData.value.type) {
            message.notify('请选择类型', message.warning);
            return
        }
        currDialogueData.value.id = uuid();
        chats.value.splice(currDialogue.value, 0, copy(currDialogueData.value));
        message.notify('插入成功', message.success);
        currDialogueData.value = {};
        ifShowEditDialogue.value = false;
    }

    function screenshot() {
        preScreenshot.value = true;
        ResizeWindow.resize();
        const node = document.getElementById('window');
        nextTick(() => {
            // 将height定为整数，防止截图下方出现白条
            node.style.height = node.scrollHeight - 30 + 'px';
            setTimeout(() => {
                downloadImage(node, {
                    windowWidth: width.value.window + 20,
                    scale: renderSettings.value.scale,
                    useCORS: true
                }, () => {
                    preScreenshot.value = false;
                    node.style.height = null;
                    setTimeout(() => {
                        ResizeWindow.resize()
                    }, 50)
                })
            }, 100)
        })
    }

    const ifShowClear = ref(false);

    function clearChats() {
        message.confirm(
            '即将清空所有对话',
            '提示',
            () => {
                DataControl.clear(0);
                currDialogue.value = 0;
                currDialogueData.value = {};
                ifShowClear.value = false;
            }
        )
    }

    function clearAll() {
        message.confirm(
            '即将清空所有角色、对话',
            '提示',
            () => {
                DataControl.clear(1);
                currChar.value = "";
                currDialogue.value = 0;
                currDialogueData.value = {};
                ifShowClear.value = false;
            }
        )
    }

    const avatarsJs = inject('avatarsJs');

    function showCreateOption() {
        options.value = [[uuid(), '']];
        ifShowCreateOption.value = true
    }

    function createOptionDialogue() {
        ifShowCreateOption.value = false;
        createDialogue({
            content: copy(options.value),
            type: 'option'
        })
    }

    const ifShowCopy = ref(false);
    const copyChars = ref([]);

    function handleCopy() {
        if (copyChars.value.length === 0) {
            message.notify('请选择至少一个角色', message.warning);
            return
        }
        const last = copyChars.value.length - 1;
        for (let i = 0; i < copyChars.value.length; i++) {
            copyDialogue(currDialogue.value, {char: copyChars.value[i]}, {locate: i === last, save: i === last})
        }
        copyChars.value = [];
        ifShowCopy.value = false;
        ifShowEditDialogue.value = false
    }

</script>


<template>
    <div :class="renderSettings.style">
        <div class="render">
            <div id="body" :style="{background: renderSettings.background}">
                <Settings/>
                <Savefile v-model="ifShowSavefile"/>
                <el-dialog v-model="ifShowEditChar" :title="createChar?'创建新角色':'编辑角色'" :width="dialogWidth"
                           @closed="() => {DataControl.save('chars'); clearNewChar()}">
                    <div style="display: flex; flex-wrap: wrap">
                        <div style="width: 100%; display: flex;">
                            <el-upload
                                    action="#"
                                    drag
                                    :show-file-list="false"
                                    class="avatar-uploader"
                                    accept="image/png, image/jpeg, image/gif"
                                    :before-upload="(file) => {defaultName='';return uploadAvatar(file)}"
                            >
                                <div class="container"><img v-if="newChar.avatar"
                                                            :src="images.hasOwnProperty(newChar.avatar) ? images[newChar.avatar].src : StaticUrl + newChar.avatar"/>
                                    <el-icon v-else class="avatar-uploader-icon">
                                        <Plus/>
                                    </el-icon>
                                </div>
                            </el-upload>
                            <div style="width: calc(100% - 100px); padding: 5px 0 0 10px">
                                名称：
                                <el-input v-model="newChar.name" style="margin-top: 10px" :placeholder="defaultName"
                                          @keypress.enter="createChar && editChar()"></el-input>
                                <div style="margin-top: 5px">
                                    头像位置
                                    <el-switch
                                            v-model="newChar.right"
                                            active-text="右"
                                            inactive-text="左"
                                            style="--el-switch-on-color: #a0cfff; --el-switch-off-color: #a0cfff"
                                    ></el-switch>
                                </div>
                            </div>
                        </div>
                        <div style="width: 100%; margin-top: 10px">
                            <el-button style="width: 60%" @click="ifShowSelectChar=true">
                                从素材库中选择角色
                            </el-button>
                            <el-button style="width: calc(40% - 12px)" @click="editChar">{{createChar?'创建':'删除'}}
                            </el-button>
                        </div>
                    </div>
                </el-dialog>
                <el-dialog v-model="ifShowSelectChar" title="选择角色" :width="dialogWidth" top="10vh"
                           @open="loadChar('arknights');initSearchChar()"
                           @closed="searchCharHandler('');searchChar=''">
                    <!--        素材库选择角色-->
                    <template v-if="ifShowSelectChar">
                        <el-input placeholder="搜索更多角色" v-model="searchChar" id="searchCharInput"></el-input>
                        <template v-if="searchResult">
                            <el-scrollbar max-height="50vh" style="width: 100%">
                                <div class="avatar-bar">
                                    <div class="frame" v-for="char in searchResult" :key="char[0]">
                                        <img :src="StaticUrl + char[1]" loading="lazy" :title="char[2]"
                                             @click="() => {selectChar(char);defaultName=char[2]}">
                                    </div>
                                </div>
                            </el-scrollbar>
                        </template>
                        <div v-else
                             style="height: 150px; display: flex; justify-content: center; align-items: center; flex-flow: column;color: grey">
                            <p>No Result</p>
                            <p>Tips: 素材库仅包含干员/敌人/召唤物/装置</p>
                        </div>
                    </template>
                </el-dialog>
                <el-dialog v-model="ifShowEditDialogue" :title="editDialogue?'编辑对话':'插入对话'" :width="dialogWidth"
                           @closed="() => {clearDialogueData();DataControl.save('chats')}"
                           :before-close="editDialogue?null:ensureClose">
                    <component v-if="editor" :is="editor" v-model="currDialogueData.content"/>
                    <el-upload v-else-if="currDialogueData.type==='image'"
                               action="#"
                               drag
                               :show-file-list="false"
                               class="image-uploader"
                               accept="image/png, image/jpeg, image/gif"
                               :before-upload="uploadImage"
                    >
                        <div class="container">
                            <el-scrollbar v-if="images[currDialogueData.content]">
                                <img :src="images[currDialogueData.content].src" style="width:100%"/>
                            </el-scrollbar>

                            <el-icon v-else class="avatar-uploader-icon">
                                <Plus/>
                            </el-icon>
                        </div>
                    </el-upload>
                    <el-input v-else
                              v-model="currDialogueData.content"
                              :autosize="{minRows: 1, maxRows: 5}"
                              resize="none"
                              type="textarea"
                              :disabled="currDialogueData.type==='image'"
                    ></el-input>
                    <div class="edit-bar" style="margin-top: 5px">
                        <div style="width: calc(50% - 2px); display: flex">
                            <CharSelector v-model="currDialogueData.char" narration/>
                        </div>
                        <div style="width: calc(50% - 3px); margin-left: 5px; display: flex">
                            <el-select v-model="currDialogueData.type" style="flex-grow: 1"
                                       :disabled="['image','option'].indexOf(currDialogueData.type) !== -1 && editDialogue"
                                       placeholder="类型"
                                       @change="() => {if(!editDialogue) {currDialogueData.content=TypeDefault[currDialogueData.type]}}"
                            >
                                <el-option
                                        v-for="(text, type) in TypeDict"
                                        :key="type"
                                        :label="text"
                                        :value="type"
                                        :disabled="['image','option'].indexOf(type) !== -1 && editDialogue"
                                />
                            </el-select>
                        </div>
                        <div style="width: 100%;height: 5px; margin: 2px 0; border-bottom: var(--el-border-color) dashed 1px"></div>
                        <div v-if="editDialogue" class="column-display" style="width: 100%; margin-top: 5px">
                            <el-button style="width: 100%" @click="delDialogue">删除</el-button>
                            <el-button style="width: 100%; margin-left: 0" @click="ifShowCopy=true">复读</el-button>
                            <el-button style="width: 100%; margin-left: 0" @click="switchEdit(false)">向上插入</el-button>
                        </div>
                        <div v-else class="column-display" style="width: 100%; margin-top: 5px">
                            <el-button style="width: 100%" @click="insertDialogue">插入</el-button>
                            <el-button style="width: 100%; margin-left: 0"
                                       @click="() => {clearDialogueData();switchEdit(true)}">返回
                            </el-button>
                        </div>
                    </div>

                </el-dialog>
                <el-dialog v-model="ifShowAt" :width="dialogWidth"
                           title="想@哪个角色?"
                           :modal="false">
                    <CharSelector v-model="atWho"
                                  v-model:select="atWhoSelRef"
                                  style="width: 100%"
                                  @change="handleAt" @visible-change="(visible) => {if (!visible) {ifShowAt=false}}"/>
                </el-dialog>
                <el-dialog v-model="ifShowCreateOption" title="创建选项" :width="dialogWidth" :before-close="ensureClose"
                           :show-close="false">
                    <Option v-model="options" extraButton="创建" @done="createOptionDialogue"/>
                </el-dialog>
                <el-dialog v-model="ifShowCopy" title="请选择要复读的角色" :width="dialogWidth" @closed="copyChars = []">
                    <el-button style="width: 100%;" @click="handleCopy">复读</el-button>
                    <CharSelector v-model="copyChars" style="width: 100%; margin-top: 5px" :narration="true"
                                  :multiple="true" :filterable="false"/>
                </el-dialog>
                <div class="drawer" :class="showToolBar?'show':''">
                    <div class="bar" @click="screenshot">
                        <el-icon color="lightgrey" :size="35">
                            <Crop/>
                        </el-icon>
                        截屏
                    </div>
                    <div class="bar" @click="ifShowAnnouncement=true">
                        <el-icon color="lightgrey" :size="35">
                            <Notification/>
                        </el-icon>
                        公告
                    </div>
                    <div class="bar" @click="toGuide">
                        <el-icon :size="35">
                            <Compass/>
                        </el-icon>
                        指南
                    </div>
                    <div class="bar" @click="ifShowClear=true">
                        <el-icon color="lightgrey" :size="35">
                            <Delete/>
                        </el-icon>
                        清空
                    </div>
                    <el-dialog v-model="ifShowClear" title="请选择要清空的类型" :width="dialogWidth">
                        <div style="display: flex; column-gap: 5px">
                            <el-button size="large" style="width: 100%;" @click="clearChats">对话</el-button>
                            <el-button size="large" style="width:100%; margin: 0" @click="clearAll">全部</el-button>
                        </div>
                    </el-dialog>
                    <div class="bar" @click="ifShowSavefile=true">
                        <el-icon color="lightgrey" :size="35">
                            <Collection/>
                        </el-icon>
                        存档
                    </div>
                    <div class="bar" @click="DataControl.withdraw">
                        <el-icon color="lightgrey" :size="35">
                            <Back/>
                        </el-icon>
                        撤回
                    </div>
                    <div class="bar" @click="DataControl.redo">
                        <el-icon color="lightgrey" :size="35">
                            <Right/>
                        </el-icon>
                        重做
                    </div>
                    <div class="bar" @click="downloadData">
                        <el-icon color="lightgrey" :size="35">
                            <Download/>
                        </el-icon>
                        导出
                    </div>
                    <div class="bar" style="position: relative">
                        <el-icon color="lightgrey" :size="35">
                            <Upload/>
                        </el-icon>
                        导入
                        <el-upload
                                action="#"
                                :show-file-list="false"
                                class="avatar-uploader"
                                accept="application/json"
                                :before-upload="(file) => uploadData(file,resizeScroll)"
                                style="position: absolute; width: 100%; height: 50px; overflow: hidden"
                        >
                            <div style=" width: 80px; height: 50px; user-select: none">
                            </div>
                        </el-upload>
                    </div>
                    <div class="bar" @click="ifShowSettings=true">
                        <el-icon color="lightgrey" :size="35">
                            <Setting/>
                        </el-icon>
                        设置
                    </div>
                    <div class="bar" @click="ifShowAbout=true">
                        <el-icon color="lightgrey" :size="35">
                            <CoffeeCup/>
                        </el-icon>
                        关于
                    </div>
                </div>
                <Transition name="fade">
                    <div v-if="showToolBar && toolBarMask" @click="showToolBar=false" class="drawer-mask"></div>
                </Transition>
                <el-scrollbar :height="scrollHeight" ref="scroll">
                    <div class="body">
                        <div class="window" id="window"
                             :style="{width: width.window+'px', background: renderSettings.background}"
                        >
                            <Dialogue v-for="(dialogue, index) in chats" @edit="showEditDialogue" @plus1="copyDialogue"
                                      :data="chats[index]" :index="index" :key="dialogue.id" :plus1="plus1 === index"
                                      style="position:relative"></Dialogue>
                        </div>
                        <div id="operateBar" class="operateBar" :style="{width: windowWidth + 'px'}">
                            <div class="button-bar">
                                <el-icon color="#707070" :size="35"
                                         style="margin-right: 5px; position: relative" :style="arrowStyle"
                                         @click="() => {ifShowMoreType = !ifShowMoreType; roll360()}">
                                    <ArrowUp/>
                                </el-icon>
                                <el-icon @click="createTextDialogue('monologue')" color="#707070" :size="35">
                                    <ChatDotSquare/>
                                </el-icon>
                            </div>
                            <textarea class="textarea" id="textarea" v-model="textarea"
                                      :placeholder="tipControl.tip.value"
                                      @keydown.ctrl.enter="createTextDialogue('chat')"
                                      @input="processInput"></textarea>
                            <div class="button-bar">
                                <el-icon @click="createTextDialogue('chat')" color="#808080" :size="35">
                                    <Promotion/>
                                </el-icon>
                            </div>
                            <div class="moretype-bar" :class="{show: ifShowMoreType}">
                                <div class="block" @click="clickBySelector('#uploadImage > div > input')">
                                    <el-upload id="uploadImage"
                                               action="#"
                                               :show-file-list="false"
                                               class="avatar-uploader"
                                               accept="image/png, image/jpeg, image/gif"
                                               :before-upload="createImageDialogue"
                                               style="position: absolute; width: 0; height: 0"
                                    ></el-upload>
                                    <el-icon color="#707070" :size="35">
                                        <Picture/>
                                    </el-icon>
                                    图片
                                </div>
                                <div class="block" @click="showCreateOption">
                                    <el-icon color="#707070" :size="35">
                                        <Operation/>
                                    </el-icon>
                                    选项
                                </div>
                                <div class="block" @click="createTextDialogue('select')">
                                    <el-icon color="#707070" :size="35">
                                        <Edit/>
                                    </el-icon>
                                    选择
                                </div>
                                <div class="block" @click="createTextDialogue('title')">
                                    <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"
                                         data-v-029747aa="" style="width: 35px; height: 35px">
                                        <path d="m199.04 672.64 193.984 112 224-387.968-193.92-112-224 388.032zm-23.872 60.16 32.896 148.288 144.896-45.696L175.168 732.8zM455.04 229.248l193.92 112 56.704-98.112-193.984-112-56.64 98.112zM104.32 708.8l384-665.024 304.768 175.936L409.152 884.8h.064l-248.448 78.336L104.32 708.8zm384 254.272v-64h448v64h-448z"
                                              fill="#707070"></path>
                                    </svg>
                                    标题
                                </div>
                            </div>
                            <div class="char-bar">
                                <el-scrollbar :max-height="120" style="width: calc(100% - 55px)">
                                    <div class="container">
                                        <div v-for="(char, id) in chars" :key="id"
                                             :class="[id === currChar?'char-curr':'char']"
                                             @click="setCurr(id)">
                                            <img :src="avatars[id]">
                                        </div>
                                        <div class="option"
                                             style="background: #686868; position:relative; width: 51px; height: 51px; margin: 3px"
                                             @click="showEditChar(true)">
                                            <svg class="roll" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"
                                                 data-v-029747aa="" style="background: #707070">
                                                <path fill="#858585"
                                                      d="M512 64a448 448 0 1 1 0 896 448 448 0 0 1 0-896zm-38.4 409.6H326.4a38.4 38.4 0 1 0 0 76.8h147.2v147.2a38.4 38.4 0 0 0 76.8 0V550.4h147.2a38.4 38.4 0 0 0 0-76.8H550.4V326.4a38.4 38.4 0 1 0-76.8 0v147.2z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                </el-scrollbar>
                                <div style="display: flex; align-items: center; justify-content: center;">
                                    <div class="option edit" style="height: 80%">
                                        <div v-if="currChar" style="width: 40px; height: 40px"
                                             @click="showEditChar(false)">
                                            <svg class="roll" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"
                                                 data-v-029747aa="">
                                                <path fill="#606060"
                                                      d="M600.704 64a32 32 0 0 1 30.464 22.208l35.2 109.376c14.784 7.232 28.928 15.36 42.432 24.512l112.384-24.192a32 32 0 0 1 34.432 15.36L944.32 364.8a32 32 0 0 1-4.032 37.504l-77.12 85.12a357.12 357.12 0 0 1 0 49.024l77.12 85.248a32 32 0 0 1 4.032 37.504l-88.704 153.6a32 32 0 0 1-34.432 15.296L708.8 803.904c-13.44 9.088-27.648 17.28-42.368 24.512l-35.264 109.376A32 32 0 0 1 600.704 960H423.296a32 32 0 0 1-30.464-22.208L357.696 828.48a351.616 351.616 0 0 1-42.56-24.64l-112.32 24.256a32 32 0 0 1-34.432-15.36L79.68 659.2a32 32 0 0 1 4.032-37.504l77.12-85.248a357.12 357.12 0 0 1 0-48.896l-77.12-85.248A32 32 0 0 1 79.68 364.8l88.704-153.6a32 32 0 0 1 34.432-15.296l112.32 24.256c13.568-9.152 27.776-17.408 42.56-24.64l35.2-109.312A32 32 0 0 1 423.232 64H600.64zm-23.424 64H446.72l-36.352 113.088-24.512 11.968a294.113 294.113 0 0 0-34.816 20.096l-22.656 15.36-116.224-25.088-65.28 113.152 79.68 88.192-1.92 27.136a293.12 293.12 0 0 0 0 40.192l1.92 27.136-79.808 88.192 65.344 113.152 116.224-25.024 22.656 15.296a294.113 294.113 0 0 0 34.816 20.096l24.512 11.968L446.72 896h130.688l36.48-113.152 24.448-11.904a288.282 288.282 0 0 0 34.752-20.096l22.592-15.296 116.288 25.024 65.28-113.152-79.744-88.192 1.92-27.136a293.12 293.12 0 0 0 0-40.256l-1.92-27.136 79.808-88.128-65.344-113.152-116.288 24.96-22.592-15.232a287.616 287.616 0 0 0-34.752-20.096l-24.448-11.904L577.344 128zM512 320a192 192 0 1 1 0 384 192 192 0 0 1 0-384zm0 64a128 128 0 1 0 0 256 128 128 0 0 0 0-256z"></path>
                                            </svg>
                                        </div>
                                        <div v-else class="scale" @click="showToolBar=!showToolBar">
                                            <svg xmlns="http://www.w3.org/2000/svg"
                                                 viewBox="0 0 16 16" focusable="false"
                                                 style="stroke: #606060">
                                                <path d="M14 3.5H2v1h12v-1zM14 7.5H2v1h12v-1zM14 11.5H2v1h12v-1z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </el-scrollbar>
            </div>
        </div>
    </div>
</template>

<style src=".global.css"></style>
<style src=".scoped.css" scoped></style>
<style>
    .avatar-bar .frame {
        width: v-bind('avatarBarFrameWidth');
        height: v-bind('avatarBarFrameWidth')
    }

    .drawer-mask {
        opacity: 0.5;
    }

    .fade-enter-active,
    .fade-leave-active {
        transition: opacity 0.5s ease;
    }

    .fade-enter-from,
    .fade-leave-to {
        opacity: 0;
    }
</style>
